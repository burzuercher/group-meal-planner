rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function: Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function: Check if user is a member of the group
    function isMemberOfGroup(groupId) {
      return isAuthenticated() &&
             request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.memberIds;
    }

    // Helper function: Check if user is joining the group
    function isJoiningGroup(groupId) {
      return isAuthenticated() &&
             // User is NOT currently a member
             !(request.auth.uid in resource.data.memberIds) &&
             // User IS being added to memberIds in this update
             (request.auth.uid in request.resource.data.memberIds);
    }

    // Groups collection
    match /groups/{groupId} {
      // Anyone authenticated can create a group (they become the first member)
      allow create: if isAuthenticated() &&
                      request.resource.data.memberIds[0] == request.auth.uid;

      // Members can read their group data
      // Also allow reading for code validation (when creating/joining groups)
      allow read: if isAuthenticated();

      // Members can update group (for editing name, etc.)
      // OR users can update to join the group (add themselves to memberIds)
      allow update: if isMemberOfGroup(groupId) || isJoiningGroup(groupId);

      // No one can delete groups (prevent accidental deletion)
      // If you want to allow deletion, add a Cloud Function for it
      allow delete: if false;

      // Menus subcollection
      match /menus/{menuId} {
        // Members can read all menus in their group
        allow read: if isMemberOfGroup(groupId);

        // Members can create menus in their group
        allow create: if isMemberOfGroup(groupId);

        // Members can update menus in their group
        allow update: if isMemberOfGroup(groupId);

        // Members can delete menus they created
        allow delete: if isMemberOfGroup(groupId);

        // Menu items subcollection
        match /items/{itemId} {
          // Members can read all items in menus in their group
          allow read: if isMemberOfGroup(groupId);

          // Members can create items in menus in their group
          allow create: if isMemberOfGroup(groupId);

          // Members can update items in menus in their group
          allow update: if isMemberOfGroup(groupId);

          // Members can delete items in menus in their group
          allow delete: if isMemberOfGroup(groupId);
        }
      }
    }

    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
